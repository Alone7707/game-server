<template>
  <div class="min-h-screen bg-gradient-to-br from-slate-900 via-orange-900/20 to-slate-900 p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
      <!-- é¡¶éƒ¨æ ‡é¢˜ -->
      <div class="text-center mb-8">
        <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-500 mb-2">
          ğŸ’£ ç‚¸å¼¹äºº
        </h1>
        <p class="text-slate-400">ç»å…¸æ³¡æ³¡å ‚ç©æ³•</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- å·¦ä¾§ï¼šæ“ä½œåŒº -->
        <div class="space-y-4">
          <!-- å½“å‰ç©å®¶ -->
          <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-4 border border-slate-700/50 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="text-2xl">ğŸ‘¤</span>
              <span class="text-white font-medium">{{ userName }}</span>
            </div>
            <button
              @click="showNameModal = true"
              class="text-sm text-slate-400 hover:text-orange-400 transition"
            >
              ä¿®æ”¹
            </button>
          </div>

          <!-- å¿«é€ŸåŠ å…¥å’Œåˆ›å»ºæˆ¿é—´ -->
          <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
            <button
              @click="quickJoin"
              class="w-full py-3 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white rounded-xl font-semibold transition mb-3"
            >
              ğŸ® å¿«é€ŸåŠ å…¥
            </button>
            <button
              @click="showCreateModal = true"
              class="w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-semibold transition border border-slate-600"
            >
              â• åˆ›å»ºæˆ¿é—´
            </button>
          </div>

          <!-- æ¸¸æˆè§„åˆ™ -->
          <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
            <h3 class="text-orange-400 font-semibold mb-4 flex items-center gap-2">
              <span>ğŸ“–</span> æ¸¸æˆè§„åˆ™
            </h3>
            <ul class="text-slate-400 text-sm space-y-2">
              <li>â€¢ ç‚¸å¼¹çˆ†ç‚¸ä¼šäº§ç”Ÿåå­—å½¢ç«ç„°</li>
              <li>â€¢ ç‚¸å¼¹å¯ä»¥å¼•ç‡ƒå…¶ä»–ç‚¸å¼¹ï¼ˆè¿é”çˆ†ç‚¸ï¼‰</li>
              <li>â€¢ ç‚¸å¼€ç –å—å¯èƒ½è·å¾—é“å…·</li>
              <li>â€¢ æœ€åå­˜æ´»çš„ç©å®¶è·èƒœ</li>
            </ul>
          </div>

          <!-- é“å…·è¯´æ˜ -->
          <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
            <h3 class="text-orange-400 font-semibold mb-4 flex items-center gap-2">
              <span>ğŸ</span> é“å…·è¯´æ˜
            </h3>
            <div class="text-slate-400 text-xs space-y-1">
              <div>ğŸ’£ æ³¡æ³¡+1 | ğŸ’§ èŒƒå›´+1 | ğŸ‘Ÿ é€Ÿåº¦+1</div>
              <div>ğŸ¦¶ è¸¢æ³¡æ³¡ | ğŸ›¡ï¸ ç›¾ç‰Œ | ğŸ“Œ é’ˆ</div>
              <div>ğŸ’¥ æœ€å¤§æ³¡æ³¡ | ğŸŒŠ æœ€å¤§èŒƒå›´</div>
            </div>
          </div>

          <!-- æ“ä½œè¯´æ˜ -->
          <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
            <h3 class="text-orange-400 font-semibold mb-4 flex items-center gap-2">
              <span>ğŸ®</span> æ“ä½œè¯´æ˜
            </h3>
            <div class="text-slate-400 text-sm space-y-2">
              <div class="flex items-center gap-3">
                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs">â†‘â†“â†â†’</kbd>
                <span>æˆ–</span>
                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs">WASD</kbd>
                <span>ç§»åŠ¨</span>
              </div>
              <div class="flex items-center gap-3">
                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs">ç©ºæ ¼</kbd>
                <span>æ”¾ç½®ç‚¸å¼¹</span>
              </div>
              <div class="flex items-center gap-3">
                <kbd class="px-2 py-1 bg-slate-700 rounded text-xs">E</kbd>
                <span>å°„é’ˆï¼ˆéœ€é“å…·ï¼‰</span>
              </div>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šæˆ¿é—´åˆ—è¡¨ -->
        <div class="lg:col-span-2">
          <div class="bg-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
            <div class="flex items-center justify-between mb-4">
              <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <span>ğŸ </span> æˆ¿é—´åˆ—è¡¨
              </h2>
              <button
                @click="refreshRooms"
                class="px-3 py-1 text-sm bg-slate-700 hover:bg-slate-600 text-slate-300 rounded-lg transition"
              >
                ğŸ”„ åˆ·æ–°
              </button>
            </div>

            <div v-if="rooms.length === 0" class="text-center py-12 text-slate-500">
              æš‚æ— æˆ¿é—´ï¼Œå¿«æ¥åˆ›å»ºä¸€ä¸ªå§ï¼
            </div>

            <div v-else class="space-y-3">
              <div
                v-for="room in rooms"
                :key="room.id"
                class="flex items-center justify-between p-4 bg-slate-700/50 rounded-xl border border-slate-600/50 hover:border-orange-500/50 transition cursor-pointer"
                @click="joinRoom(room)"
              >
                <div>
                  <div class="font-medium text-white flex items-center gap-2">
                    {{ room.name }}
                    <span v-if="room.hasPassword" class="text-amber-400">ğŸ”’</span>
                  </div>
                  <div class="text-sm text-slate-400">æˆ¿ä¸»: {{ room.hostName }}</div>
                </div>
                <div class="text-right">
                  <div class="text-orange-400 font-medium">
                    {{ room.playerCount }}/{{ room.maxPlayers }}
                  </div>
                  <div class="text-xs text-slate-500">ç©å®¶</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- åˆ›å»ºæˆ¿é—´å¼¹çª— -->
    <div
      v-if="showCreateModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50"
      @click.self="showCreateModal = false"
    >
      <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-md border border-slate-700">
        <h3 class="text-xl font-bold text-white mb-6">åˆ›å»ºæˆ¿é—´</h3>

        <div class="space-y-4">
          <div>
            <label class="block text-slate-400 text-sm mb-2">æˆ¿é—´åç§°</label>
            <input
              v-model="createForm.roomName"
              type="text"
              placeholder="è¾“å…¥æˆ¿é—´åç§°"
              class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-orange-500"
            />
          </div>

          <div>
            <label class="block text-slate-400 text-sm mb-2">æˆ¿é—´å¯†ç ï¼ˆå¯é€‰ï¼‰</label>
            <input
              v-model="createForm.password"
              type="password"
              placeholder="ä¸å¡«åˆ™å…¬å¼€"
              class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-orange-500"
            />
          </div>

          <div>
            <label class="block text-slate-400 text-sm mb-2">ç©å®¶äººæ•°</label>
            <div class="flex gap-2">
              <button
                v-for="n in [2, 3, 4, 5, 6]"
                :key="n"
                @click="setPlayerCount(n)"
                :class="[
                  'flex-1 py-2 rounded-lg transition text-sm',
                  createForm.rules.playerCount === n
                    ? 'bg-orange-500 text-white'
                    : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                ]"
              >
                {{ n }}äºº
              </button>
            </div>
          </div>

          <div>
            <label class="block text-slate-400 text-sm mb-2">åœ°å›¾å¤§å°</label>
            <div class="flex gap-2">
              <button
                v-for="size in ['small', 'medium', 'large']"
                :key="size"
                @click="setMapSize(size as 'small' | 'medium' | 'large')"
                :disabled="!canSelectMapSize(size as 'small' | 'medium' | 'large')"
                :class="[
                  'flex-1 py-2 rounded-lg transition',
                  createForm.rules.mapSize === size
                    ? 'bg-orange-500 text-white'
                    : !canSelectMapSize(size as 'small' | 'medium' | 'large')
                      ? 'bg-slate-800 text-slate-600 cursor-not-allowed'
                      : 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                ]"
              >
                {{ size === 'small' ? 'å°' : size === 'medium' ? 'ä¸­' : 'å¤§' }}
              </button>
            </div>
            <p v-if="createForm.rules.playerCount > 4" class="text-xs text-slate-500 mt-1">
              5-6äººéœ€è¦ä¸­/å¤§åœ°å›¾
            </p>
          </div>
        </div>

        <div class="flex gap-3 mt-6">
          <button
            @click="showCreateModal = false"
            class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition"
          >
            å–æ¶ˆ
          </button>
          <button
            @click="createRoom"
            class="flex-1 py-2 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white rounded-lg font-semibold transition"
          >
            åˆ›å»º
          </button>
        </div>
      </div>
    </div>

    <!-- åŠ å…¥æˆ¿é—´å¯†ç å¼¹çª— -->
    <div
      v-if="showPasswordModal"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50"
      @click.self="showPasswordModal = false"
    >
      <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700">
        <h3 class="text-xl font-bold text-white mb-4">è¾“å…¥æˆ¿é—´å¯†ç </h3>
        <input
          v-model="joinPassword"
          type="password"
          placeholder="è¯·è¾“å…¥å¯†ç "
          class="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:border-orange-500 mb-4"
          @keyup.enter="confirmJoin"
        />
        <div class="flex gap-3">
          <button
            @click="showPasswordModal = false"
            class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition"
          >
            å–æ¶ˆ
          </button>
          <button
            @click="confirmJoin"
            class="flex-1 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-semibold transition"
          >
            åŠ å…¥
          </button>
        </div>
      </div>
    </div>

    <!-- åç§°è®¾ç½®å¼¹çª— -->
    <div
      v-if="showNameModal"
      class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50"
    >
      <div class="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700">
        <h3 class="text-xl font-bold text-white mb-2 text-center">ğŸ‘¤ æ¬¢è¿æ¥åˆ°ç‚¸å¼¹äºº</h3>
        <p class="text-slate-400 text-sm mb-6 text-center">è¯·å…ˆè®¾ç½®ä½ çš„æ¸¸æˆåç§°</p>

        <input
          v-model="tempName"
          type="text"
          placeholder="è¾“å…¥ä½ çš„åå­—"
          maxlength="12"
          class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-white text-center text-lg focus:outline-none focus:border-orange-500 mb-4"
          @keyup.enter="confirmName"
        />

        <button
          @click="confirmName"
          class="w-full py-3 bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white rounded-xl font-semibold transition"
        >
          ç¡®è®¤è¿›å…¥
        </button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue'
import { useRouter } from 'vue-router'
import { io, Socket } from 'socket.io-client'

interface RoomInfo {
  id: string
  name: string
  hostName: string
  playerCount: number
  maxPlayers: number
  hasPassword: boolean
}

interface RoomRules {
  playerCount: number
  mapSize: 'small' | 'medium' | 'large'
}

const router = useRouter()
const socket = ref<Socket | null>(null)
const rooms = ref<RoomInfo[]>([])
const showCreateModal = ref(false)
const showPasswordModal = ref(false)
const joinPassword = ref('')
const selectedRoom = ref<RoomInfo | null>(null)

const userId = ref('')
const userName = ref('')

const createForm = ref({
  roomName: '',
  password: '',
  rules: {
    playerCount: 4,
    mapSize: 'medium' as 'small' | 'medium' | 'large',
  },
})

const showNameModal = ref(false)
const tempName = ref('')

onMounted(() => {
  // è·å–æˆ–ç”Ÿæˆç”¨æˆ·ID
  userId.value = localStorage.getItem('bomberman_userId') || `user_${Math.random().toString(36).substring(2, 8)}`
  localStorage.setItem('bomberman_userId', userId.value)
  
  // æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®åç§°
  const savedName = localStorage.getItem('bomberman_userName')
  if (savedName) {
    userName.value = savedName
    initSocket()
  } else {
    showNameModal.value = true
  }
})

function confirmName() {
  if (!tempName.value.trim()) {
    alert('è¯·è¾“å…¥åç§°')
    return
  }
  userName.value = tempName.value.trim()
  localStorage.setItem('bomberman_userName', userName.value)
  showNameModal.value = false
  tempName.value = ''
  
  // å¦‚æœ socket æœªåˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–
  if (!socket.value) {
    initSocket()
  }
}

onUnmounted(() => {
  socket.value?.disconnect()
})

function initSocket() {
  socket.value = io()

  socket.value.on('connect', () => {
    socket.value?.emit('bomberman:room:list')
  })

  socket.value.on('bomberman:room:list', (data: RoomInfo[]) => {
    rooms.value = data
  })

  socket.value.on('bomberman:room:created', (data: { room: any }) => {
    router.push(`/bomberman/room/${data.room.id}`)
  })

  socket.value.on('bomberman:room:joined', (data: { room: any }) => {
    router.push(`/bomberman/room/${data.room.id}`)
  })

  socket.value.on('bomberman:room:error', (data: { message: string }) => {
    alert(data.message)
  })
}

function refreshRooms() {
  socket.value?.emit('bomberman:room:list')
}

function createRoom() {
  socket.value?.emit('bomberman:room:create', {
    userId: userId.value,
    userName: userName.value,
    roomName: createForm.value.roomName || `${userName.value}çš„æˆ¿é—´`,
    rules: createForm.value.rules,
    password: createForm.value.password || undefined,
  })
}

function joinRoom(room: RoomInfo) {
  if (room.hasPassword) {
    selectedRoom.value = room
    showPasswordModal.value = true
  } else {
    socket.value?.emit('bomberman:room:join', {
      roomId: room.id,
      userId: userId.value,
      userName: userName.value,
    })
  }
}

function confirmJoin() {
  if (!selectedRoom.value) return
  socket.value?.emit('bomberman:room:join', {
    roomId: selectedRoom.value.id,
    userId: userId.value,
    userName: userName.value,
    password: joinPassword.value,
  })
  showPasswordModal.value = false
  joinPassword.value = ''
  selectedRoom.value = null
}

function quickJoin() {
  // å°è¯•åŠ å…¥ç¬¬ä¸€ä¸ªæœªæ»¡ä¸”æ— å¯†ç çš„æˆ¿é—´
  const availableRoom = rooms.value.find(r => !r.hasPassword && r.playerCount < r.maxPlayers)
  if (availableRoom) {
    socket.value?.emit('bomberman:room:join', {
      roomId: availableRoom.id,
      userId: userId.value,
      userName: userName.value,
    })
  } else {
    // æ²¡æœ‰å¯åŠ å…¥çš„æˆ¿é—´ï¼Œåˆ›å»ºæ–°æˆ¿é—´
    socket.value?.emit('bomberman:room:create', {
      userId: userId.value,
      userName: userName.value,
      roomName: `${userName.value}çš„æˆ¿é—´`,
      rules: { playerCount: 4, mapSize: 'medium' },
    })
  }
}

// åœ°å›¾å¤§å°é™åˆ¶ï¼šå°åœ°å›¾æœ€å¤š4äºº
function canSelectMapSize(size: 'small' | 'medium' | 'large'): boolean {
  const playerCount = createForm.value.rules.playerCount
  if (size === 'small' && playerCount > 4) return false
  return true
}

function setPlayerCount(n: number) {
  createForm.value.rules.playerCount = n
  // å¦‚æœå½“å‰åœ°å›¾å¤§å°ä¸æ”¯æŒè¯¥äººæ•°ï¼Œè‡ªåŠ¨è°ƒæ•´
  if (!canSelectMapSize(createForm.value.rules.mapSize)) {
    createForm.value.rules.mapSize = 'medium'
  }
}

function setMapSize(size: 'small' | 'medium' | 'large') {
  if (canSelectMapSize(size)) {
    createForm.value.rules.mapSize = size
  }
}
</script>
